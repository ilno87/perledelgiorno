<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perla del Giorno</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root{
      --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      --card: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.8));
      --accent: linear-gradient(135deg, #06b6d4 0%, #3b82f6 50%, #8b5cf6 100%);
      --text: #f8fafc;
      --text-muted: #cbd5e1;
      --text-dim: #94a3b8;
      --border: rgba(148, 163, 184, 0.2);
      --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      --glow: 0 0 20px rgba(59, 130, 246, 0.3);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body { 
      height: 100%; 
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      overflow: hidden;
      color: var(--text);
    }
    
    .wrap { 
      height: 100vh; 
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(0.75rem, 2vw, 2rem);
      position: relative;
    }
    
    .wrap::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 30% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 70% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
      pointer-events: none;
    }
    
    .card { 
      width: 100%;
      height: 100%;
      max-width: min(950px, 100vw);
      max-height: 100vh;
      background: var(--card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: clamp(16px, 3vw, 32px);
      box-shadow: var(--shadow);
      padding: clamp(1.5rem, 4vw, 3rem);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    }
    
    .header {
      display: flex;
      flex-direction: column;
      gap: clamp(0.5rem, 1.5vw, 1rem);
      margin-bottom: clamp(1rem, 3vw, 2rem);
      flex-shrink: 0;
    }
    
    h1 { 
      font-size: clamp(1.75rem, 5vw, 2.5rem);
      font-weight: 700; 
      background: var(--accent);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex; 
      align-items: center; 
      gap: 0.75rem;
      line-height: 1.1;
    }
    
    .meta { 
      color: var(--text-dim);
      font-size: clamp(0.875rem, 2.5vw, 1.1rem);
      font-weight: 400;
      opacity: 0.9;
    }
    
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      gap: clamp(1rem, 3vw, 1.5rem);
    }
    
    .quote-section {
      flex-shrink: 0;
    }
    
    p#phrase { 
      font-size: clamp(1.25rem, 4vw, 1.75rem);
      font-weight: 400;
      line-height: 1.6; 
      color: var(--text);
      white-space: pre-wrap;
      word-wrap: break-word;
      hyphens: auto;
      position: relative;
      padding: clamp(1rem, 3vw, 1.5rem);
      background: rgba(255, 255, 255, 0.03);
      border-radius: clamp(12px, 2vw, 20px);
      border-left: 4px solid;
      border-image: var(--accent) 1;
    }
    
    p#phrase::before {
      content: '"';
      position: absolute;
      left: clamp(0.5rem, 2vw, 1rem);
      top: clamp(-0.5rem, -1vw, -0.75rem);
      font-size: clamp(2rem, 6vw, 3rem);
      color: var(--text-dim);
      opacity: 0.3;
      font-family: Georgia, serif;
    }
    
    .image-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      gap: clamp(0.75rem, 2vw, 1rem);
    }
    
    figure { 
      margin: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .imgbox { 
      position: relative; 
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--border);
      border-radius: clamp(16px, 3vw, 24px);
      overflow: hidden; 
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
      transition: all 0.3s ease;
    }
    
    .imgbox:hover {
      transform: translateY(-2px);
      box-shadow: var(--glow), 0 15px 35px rgba(0, 0, 0, 0.4);
    }
    
    .imgbox img { 
      display: block; 
      max-width: 100%; 
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      transition: transform 0.3s ease;
    }
    
    .imgbox:hover img {
      transform: scale(1.02);
    }
    
    figcaption { 
      font-size: clamp(0.875rem, 2.5vw, 1rem);
      color: var(--text-muted);
      text-align: center;
      font-weight: 400;
      opacity: 0.8;
    }
    
    .footer { 
      margin-top: clamp(1rem, 3vw, 1.5rem);
      display: flex; 
      gap: clamp(0.75rem, 2vw, 1rem);
      flex-wrap: wrap;
      flex-shrink: 0;
      justify-content: center;
      align-items: center;
    }
    
    button, a.btn { 
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      color: var(--text-muted); 
      border: 1px solid var(--border);
      padding: clamp(0.625rem, 2vw, 0.875rem) clamp(1rem, 3vw, 1.5rem);
      border-radius: clamp(8px, 2vw, 12px);
      cursor: pointer; 
      font-size: clamp(0.875rem, 2.5vw, 1rem);
      font-weight: 500;
      text-decoration: none;
      white-space: nowrap;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    button:hover, a.btn:hover { 
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
      color: var(--text);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }
    
    button:active, a.btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
      border: none;
    }
    
    .btn-primary:hover {
      filter: brightness(1.1);
      box-shadow: var(--glow);
    }
    
    .hidden { 
      display: none !important; 
    }
    
    .error { 
      background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(153, 27, 27, 0.1));
      border: 1px solid rgba(220, 38, 38, 0.3);
      color: #fca5a5; 
      padding: clamp(1rem, 3vw, 1.25rem);
      border-radius: clamp(12px, 2vw, 16px);
      font-size: clamp(0.875rem, 2.5vw, 1rem);
      backdrop-filter: blur(10px);
    }
    
    /* Animazioni */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
      animation: fadeIn 0.6s ease-out;
    }
    
    /* Ottimizzazioni per schermi piccoli */
    @media (max-height: 700px) {
      p#phrase {
        font-size: clamp(1.125rem, 3.5vw, 1.5rem);
        line-height: 1.5;
        padding: clamp(0.75rem, 2vw, 1rem);
      }
      
      .header {
        margin-bottom: clamp(0.75rem, 2vw, 1.5rem);
      }
      
      .content-area {
        gap: clamp(0.75rem, 2vw, 1rem);
      }
    }

    /* Landscape mobile ottimizzato */
    @media (max-height: 500px) and (orientation: landscape) {
      .wrap {
        padding: 0.5rem;
      }
      
      .card {
        padding: clamp(1rem, 3vw, 1.5rem);
      }
      
      h1 {
        font-size: clamp(1.5rem, 4vw, 1.75rem);
      }
      
      p#phrase {
        font-size: clamp(1rem, 3vw, 1.25rem);
        line-height: 1.4;
        padding: 0.75rem;
      }
      
      .footer {
        margin-top: 0.75rem;
        gap: 0.5rem;
      }
      
      button, a.btn {
        padding: 0.5rem 0.875rem;
        font-size: 0.875rem;
      }
    }
    
    /* Dark scrollbar per eventuali overflow */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.3);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.5);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <h1>Perla del giorno ðŸ’Ž</h1>
        <div class="meta" id="date"></div>
      </div>
      
      <div class="content-area">
        <div class="quote-section">
          <p id="phrase">Caricamentoâ€¦</p>
        </div>
        
        <div class="image-section">
          <figure id="figure" class="hidden">
            <div class="imgbox">
              <img id="img" alt="" />
            </div>
            <figcaption id="caption"></figcaption>
          </figure>
          
          <div id="error" class="error hidden"></div>
        </div>
      </div>
      
      <div class="footer">
        <button id="prev" title="Giorno precedente">â—€ï¸Ž Precedente</button>
        <button id="next" title="Giorno successivo">Successivo â–¶ï¸Ž</button>
        <button id="copy" class="btn-primary">Copia testo</button>
        <a id="openImg" class="btn hidden" href="#" target="_blank">Apri immagine</a>
      </div>
    </div>
  </div>

  <script>
  // === CONFIG ===
  const MODE = 'shuffle';       // 'shuffle' per mostrare elementi in ordine casuale senza ripetizioni (persistente con localStorage)
  const TIMEZONE = 'Europe/Rome';
  const SEED = 'perle-v3';     // cambia per rimescolare l'ordine in modalitÃ  'daily'

  // Carica l'elenco da file esterno JSON (nella root del sito)
  async function loadItems(){
    const res = await fetch('items.json', { cache: 'no-cache' });
    if(!res.ok) throw new Error('Impossibile caricare items.json: '+res.status);
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error('items.json non Ã¨ un array');
    return data;
  }

  // === UTIL PER DAILY ===
  function xmur3(str){ let h=1779033703^str.length; for(let i=0;i<str.length;i++){ h=Math.imul(h^str.charCodeAt(i),3432918353); h=h<<13|h>>>19; } return function(){ h=Math.imul(h^(h>>>16),2246822507); h=Math.imul(h^(h>>>13),3266489909); return (h^(h>>>16))>>>0; } }
  function hashString(str){ const seedFn = xmur3(str); return seedFn(); }
  function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),1|t); t^=t+Math.imul(t^(t>>>7),61|t); return ((t^(t>>>14))>>>0)/4294967296; } }
  function seededShuffle(arr, seedStr){ const seed = xmur3(seedStr)(); const rand = mulberry32(seed); const a = arr.slice(); for (let i=a.length-1; i>0; i--){ const j = Math.floor(rand()*(i+1)); [a[i], a[j]]=[a[j], a[i]]; } return a; }
  function nowInTZ(tz){ return new Date(new Date().toLocaleString('en-GB', { timeZone: tz })); }
  function startOfDayTZ(d, tz){ const p=new Intl.DateTimeFormat('en-CA',{ timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit'}).formatToParts(d); const y=+p.find(q=>q.type==='year').value; const m=+p.find(q=>q.type==='month').value; const day=+p.find(q=>q.type==='day').value; return new Date(Date.UTC(y, m-1, day)); }
  function daysSinceEpochTZ(d, tz){ const sod=startOfDayTZ(d, tz); return Math.floor(sod.getTime()/86400000); }

  // Stato
  let ITEMS = [];
  let ITEMS_HASH = 0;
  let offsetDays = 0; // usato solo in daily per sfogliare

  function pickDailyItem(items, viewDate){
    const perm = seededShuffle(items.map((_,i)=>i), SEED);
    const idx = daysSinceEpochTZ(viewDate, TIMEZONE) % items.length;
    return items[perm[idx]];
  }

  function pickRandomItem(items){
    const idx=Math.floor(Math.random()*items.length);
    return items[idx];
  }

  function setHidden(el, yes){ el.classList.toggle('hidden', !!yes); }

  // === SHUFFLE STATE (no repeat) ===
  const LS_KEY_PREFIX = 'perle_state_';
  function loadShuffleState(len, hash){
    const key = LS_KEY_PREFIX + hash;
    try{
      const raw = localStorage.getItem(key);
      if(raw){
        const st = JSON.parse(raw);
        if(Array.isArray(st.order) && st.order.length===len && Number.isInteger(st.pos)){
          let pos = Number.isInteger(st.pos) ? st.pos : 0; if(pos < 0) pos = 0; if(pos > len) pos = len; return { key, order: st.order, pos };
        }
      }
    }catch{}
    const order = seededShuffle(Array.from({length: len}, (_,i)=>i), String(hash));
    return { key, order, pos: 0 };
  }
  function saveShuffleState(state){ localStorage.setItem(state.key, JSON.stringify({order: state.order, pos: state.pos})); }
  function advanceAndGetShuffleItem(items, state){
    if(items.length===0) return { item:{text:'â€” (nessuna frase) â€”'}, state };
    if(state.pos >= state.order.length){
      state.order = seededShuffle(Array.from({length: items.length}, (_,i)=>i), String(ITEMS_HASH ^ Date.now()));
      state.pos = 0;
    }
    const idx = state.order[state.pos];
    const item = items[idx];
    state.pos += 1;
    saveShuffleState(state);
    return { item, state };
  }

  function render(){
    const elDate = document.getElementById('date');
    const elPhrase = document.getElementById('phrase');
    const elFig = document.getElementById('figure');
    const elImg = document.getElementById('img');
    const elCap = document.getElementById('caption');
    const aOpen = document.getElementById('openImg');
    const btnPrev = document.getElementById('prev');
    const btnNext = document.getElementById('next');

    let item;
    if(MODE==='shuffle'){
      const st = loadShuffleState(ITEMS.length, ITEMS_HASH);
      const res = advanceAndGetShuffleItem(ITEMS, st);
      item = res.item;
      elDate.textContent = '';
      setHidden(btnPrev, true);
      setHidden(btnNext, true);
    } else {
      const now = nowInTZ(TIMEZONE);
      const view = new Date(now.getTime() + offsetDays*86400000);
      item = pickDailyItem(ITEMS, view);
      const fmt = new Intl.DateTimeFormat('it-IT', { timeZone: TIMEZONE, weekday:'long', year:'numeric', month:'long', day:'numeric' });
      elDate.textContent = fmt.format(view);
      setHidden(btnPrev, false);
      setHidden(btnNext, false);
    }

    elPhrase.textContent = item.text || '';

    if(item.img){
      elImg.src = item.img;
      elImg.alt = item.alt || '';
      elCap.textContent = item.caption || '';
      setHidden(elFig, false);
      setHidden(aOpen, false);
      aOpen.href = item.img;
    } else {
      setHidden(elFig, true);
      setHidden(aOpen, true);
      elImg.removeAttribute('src');
      elImg.alt = '';
      elCap.textContent = '';
    }
  }

  async function init(){
    const elError = document.getElementById('error');
    try{
      ITEMS = await loadItems();
      ITEMS_HASH = hashString(JSON.stringify(ITEMS));
      if(!ITEMS.length) throw new Error('Nessun elemento in items.json');
      render();
    } catch(err){
      setHidden(elError, false);
      elError.textContent = err.message + '\nAssicurati che esista un file items.json valido nella root e che contenga un array di oggetti con almeno {"text": "..."}.';
    }
  }

  // Eventi
  document.getElementById('prev').addEventListener('click', ()=>{ if(MODE==='daily'){ offsetDays--; render(); } });
  document.getElementById('next').addEventListener('click', ()=>{ if(MODE==='daily'){ offsetDays++; render(); } });
  document.getElementById('copy').addEventListener('click', async ()=>{
    try { await navigator.clipboard.writeText(document.getElementById('phrase').textContent); const btn=document.getElementById('copy'); const t=btn.textContent; btn.textContent='Copiato! âœ“'; setTimeout(()=>btn.textContent=t, 1500); } catch(e){ alert('Impossibile copiare: '+e); }
  });

  init();
  </script>
</body>
</html>
