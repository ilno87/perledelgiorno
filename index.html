<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perla del Giorno</title>
  <style>
    :root{
      --bg:#0b1020; --card:#11162b; --text:#f5f7ff; --muted:#dfe5ff; --line:#2b3363;
    }
    /* No scroll anywhere */
    html, body { height:100%; margin:0; overflow:hidden; }
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans"; background:var(--bg); color:var(--text); }

    /* Full-viewport card with fixed grid: header / content / footer */
    .frame { height: 100dvh; display:flex; align-items:center; justify-content:center; padding: clamp(8px,2vw,20px); }
    .card  { width:min(1024px,100%); height:100%; background:var(--card); border-radius:18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); padding: clamp(12px,2.2vw,24px); display:grid; grid-template-rows:auto 1fr auto; gap:10px; }

    header h1 { margin:0; font-weight:700; font-size: clamp(1.05rem,2.2vw,1.6rem); }
    header .meta { opacity:.75; font-size:.95rem; }
    #phrase { margin:8px 0 0; white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; line-height:1.5; font-size: clamp(1rem,2.2vw,1.35rem); }

    main { min-height:0; display:flex; align-items:center; justify-content:center; }
    .imgbox { position:relative; width:100%; height:100%; max-height:100%; border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#0e1430; display:flex; align-items:center; justify-content:center; }
    .imgbox img { max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; display:block; }
    figcaption { margin-top:6px; font-size:.92rem; opacity:.9; word-break:break-word; overflow-wrap:anywhere; }

    footer { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    button, a.btn { background:#1f2647; color:var(--muted); border:1px solid var(--line); padding:10px 14px; border-radius:12px; cursor:pointer; font-size:1rem; text-decoration:none; }
    button:hover, a.btn:hover { filter: brightness(1.08); }
    .hidden { display:none !important; }

    @media (max-width: 720px){
      .card{ border-radius:14px; }
      footer{ flex-direction:column; }
      button, a.btn{ width:100%; }
    }
  </style>
</head>
<body>
  <div class="frame">
    <section class="card">
      <header>
        <h1>Perla del giorno ðŸ’Ž</h1>
        <div class="meta" id="date"></div>
        <p id="phrase">Caricamentoâ€¦</p>
      </header>

      <main>
        <figure id="figure" class="hidden" style="width:100%;height:100%;display:flex;flex-direction:column;min-height:0;">
          <div class="imgbox" id="imgbox">
            <img id="img" alt="" loading="lazy" decoding="async" />
          </div>
          <figcaption id="caption"></figcaption>
        </figure>
      </main>

      <div id="error" class="hidden" style="margin:4px 0 0;background:#2a1330;border:1px solid #7b2a3c;color:#ffd6de;padding:8px 10px;border-radius:12px"></div>

      <footer>
        <button id="prev" title="Giorno precedente">â—€ï¸Ž Giorno precedente</button>
        <button id="next" title="Giorno successivo">Giorno successivo â–¶ï¸Ž</button>
        <button id="copy">Copia testo</button>
        <a id="openImg" class="btn hidden" href="#" target="_blank" rel="noopener">Apri immagine</a>
        <button id="nextShuffle" class="hidden" title="Mostra un'altra perla">Prossima perla â†»</button>
      </footer>
    </section>
  </div>

<script>
// === CONFIG ===
const MODE='shuffle';      // 'shuffle' = random senza ripetizioni (persistente) | 'daily' = 1 al giorno
const TIMEZONE='Europe/Rome';
const SEED='perle-v5';     // usato solo in daily

// === Caricamento items ===
async function loadItems(){
  const r=await fetch('items.json',{cache:'no-cache'});
  if(!r.ok) throw new Error('Impossibile caricare items.json');
  const txt=await r.text();
  const data=JSON.parse(txt);
  if(!Array.isArray(data)) throw new Error('items.json non Ã¨ un array');
  return { items:data, hash:hashString(txt) };
}

// === Util ===
function xmur3(str){ let h=1779033703^str.length; for(let i=0;i<str.length;i++){ h=Math.imul(h^str.charCodeAt(i),3432918353); h=h<<13|h>>>19; } return function(){ h=Math.imul(h^(h>>>16),2246822507); h=Math.imul(h^(h>>>13),3266489909); return (h^(h>>>16))>>>0; } }
function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),1|t); t^=t+Math.imul(t^(t>>>7),61|t); return ((t^(t>>>14))>>>0)/4294967296; } }
function seededShuffle(arr, seedStr){ const seed=xmur3(seedStr)(); const rand=mulberry32(seed); const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rand()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function hashString(str){ const seedFn=xmur3(str); return seedFn(); }
function nowInTZ(tz){ return new Date(new Date().toLocaleString('en-GB',{timeZone:tz})); }
function startOfDayTZ(d,tz){ const p=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d); const y=+p.find(q=>q.type==='year').value; const m=+p.find(q=>q.type==='month').value; const day=+p.find(q=>q.type==='day').value; return new Date(Date.UTC(y,m-1,day)); }
function daysSinceEpochTZ(d,tz){ const sod=startOfDayTZ(d,tz); return Math.floor(sod.getTime()/86400000); }

// === Stato ===
let ITEMS=[]; let ITEMS_HASH=0; let offsetDays=0;

// === Shuffle persistente (no repeat) ===
const LS_KEY_PREFIX='perle_state_';
function loadShuffleState(len,hash){
  const key=LS_KEY_PREFIX+hash;
  try{ const raw=localStorage.getItem(key); if(raw){ const st=JSON.parse(raw); if(Array.isArray(st.order)&&st.order.length===len&&Number.isInteger(st.pos)){ let pos=st.pos; if(pos<0)pos=0; if(pos>len)pos=len; return { key, order:st.order, pos }; } } }catch{}
  const order=seededShuffle(Array.from({length:len},(_,i)=>i), String(hash));
  return { key, order, pos:0 };
}
function saveShuffleState(st){ localStorage.setItem(st.key, JSON.stringify({order:st.order,pos:st.pos})); }
function nextShuffleItem(items, st){
  if(items.length===0) return { item:{text:'â€” (nessuna frase) â€”'}, st };
  if(st.pos>=st.order.length){ st.order=seededShuffle(Array.from({length:items.length},(_,i)=>i), String(ITEMS_HASH^Date.now())); st.pos=0; }
  const idx=st.order[st.pos]; const item=items[idx]; st.pos+=1; saveShuffleState(st); return { item, st };
}

// === Rendering ===
function setHidden(el,yes){ el.classList.toggle('hidden', !!yes); }
function render(){
  const elDate=document.getElementById('date');
  const elPhrase=document.getElementById('phrase');
  const elFig=document.getElementById('figure');
  const elImg=document.getElementById('img');
  const elCap=document.getElementById('caption');
  const aOpen=document.getElementById('openImg');
  const btnPrev=document.getElementById('prev');
  const btnNext=document.getElementById('next');
  const btnNextShuffle=document.getElementById('nextShuffle');

  let item;
  if(MODE==='shuffle'){
    const st=loadShuffleState(ITEMS.length,ITEMS_HASH);
    const res=nextShuffleItem(ITEMS,st);
    item=res.item;
    elDate.textContent='';
    setHidden(btnPrev,true); setHidden(btnNext,true); setHidden(btnNextShuffle,false);
  } else {
    const now=nowInTZ(TIMEZONE); const view=new Date(now.getTime()+offsetDays*86400000);
    const perm=seededShuffle(ITEMS.map((_,i)=>i), SEED); const idx=daysSinceEpochTZ(view,TIMEZONE)%ITEMS.length; item=ITEMS[perm[idx]];
    const fmt=new Intl.DateTimeFormat('it-IT',{timeZone:TIMEZONE,weekday:'long',year:'numeric',month:'long',day:'numeric'});
    elDate.textContent=fmt.format(view);
    setHidden(btnPrev,false); setHidden(btnNext,false); setHidden(btnNextShuffle,true);
  }

  elPhrase.textContent=item.text||'';

  if(item.img){ elImg.src=item.img; elImg.alt=item.alt||''; elCap.textContent=item.caption||''; setHidden(elFig,false); setHidden(aOpen,false); aOpen.href=item.img; }
  else { setHidden(elFig,true); setHidden(aOpen,true); elImg.removeAttribute('src'); elImg.alt=''; elCap.textContent=''; }
}

// === Init ===
async function init(){
  const elError=document.getElementById('error');
  try{
    const {items,hash}=await loadItems(); ITEMS=items; ITEMS_HASH=hash;
    if(!ITEMS.length) throw new Error('Nessun elemento in items.json');
    render();
    // re-render on resize/orientation to keep everything inside viewport
    addEventListener('resize', render); addEventListener('orientationchange', render);
  }catch(err){ setHidden(elError,false); elError.textContent=err.message+'
Assicurati che esista items.json valido (array con almeno {"text":"..."}).'; }
}

// === Events ===
prev.addEventListener('click', ()=>{ if(MODE==='daily'){ offsetDays--; render(); } });
next.addEventListener('click', ()=>{ if(MODE==='daily'){ offsetDays++; render(); } });
nextShuffle.addEventListener('click', ()=>{ if(MODE==='shuffle'){ render(); } });
copy.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(phrase.textContent); const t=copy.textContent; copy.textContent='Copiato!'; setTimeout(()=>copy.textContent=t,1200);}catch(e){ alert('Impossibile copiare: '+e); } });

init();
</script>
</body>
</html>
