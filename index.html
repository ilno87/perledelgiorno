<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perla del Giorno</title>
  <style>
    :root{
      --bg:#0b1020; --card:#141a32; --text:#f5f7ff; --muted:#dfe5ff; --line:#2b3363;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    /* Layout pulito, senza scrollbar orizzontali */
    html, body { height:auto; min-height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans'; }
    .wrap { width:min(960px, 94vw); margin: clamp(12px, 2svh, 24px) auto; padding-inline: clamp(8px, 4vw, 24px); box-sizing: border-box; }
    .card { background: var(--card); padding: clamp(14px, 2.6vw, 28px); border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0 0 8px; font-size: clamp(1.3rem, 2.4vw, 1.8rem); font-weight: 800; display:flex; align-items:center; gap:.5rem }
    .meta { opacity:.75; font-size:.95rem; margin-top:2px }
    #phrase { font-size: clamp(1.1rem, 2.4vw, 1.5rem); line-height:1.6; margin: 12px 0 0; white-space: pre-wrap; word-break: break-word; overflow-wrap:anywhere }

    figure { margin: 16px 0 0; }
    .imgbox { background:#0e1430; border:1px solid var(--line); border-radius: 14px; overflow:hidden; box-shadow: 0 8px 22px rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; }
    .imgbox img{ display:block; width:100%; height:auto; max-width:100%; object-fit: contain }
    figcaption { font-size:.95rem; opacity:.9; margin-top:8px; word-break:break-word; overflow-wrap:anywhere }

    .footer { margin-top: 18px; display: flex; gap: 10px; flex-wrap: wrap; padding-bottom: max(8px, var(--safe-bottom)); }
    button, a.btn { background:#1f2647; color:var(--muted); border:1px solid var(--line); padding:10px 14px; border-radius:12px; cursor:pointer; font-size:1rem; text-decoration:none }
    button:hover, a.btn:hover { filter: brightness(1.08) }
    .hidden { display:none !important }

    /* Mobile tuning */
    @media (max-width: 640px) {
      .card { padding: 14px; border-radius: 14px; }
      h1 { font-size: clamp(1.15rem, 5vw, 1.5rem); }
      #phrase { font-size: clamp(1rem, 4.2vw, 1.25rem); }
      .footer { flex-direction: column }
      button, a.btn { width: 100% }
      /* limite di sicurezza per l’immagine su schermi piccoli, poi JS la affina */
      .imgbox { max-height: 58svh; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Perla del giorno 💎</h1>
      <div class="meta" id="date"></div>
      <p id="phrase">Caricamento…</p>

      <figure id="figure" class="hidden">
        <div class="imgbox" id="imgbox">
          <img id="img" alt="" loading="lazy" decoding="async" />
        </div>
        <figcaption id="caption"></figcaption>
      </figure>

      <div id="error" class="hidden" style="margin-top:12px;background:#2a1330;border:1px solid #7b2a3c;color:#ffd6de;padding:10px 12px;border-radius:12px"></div>

      <div class="footer">
        <!-- In shuffle le frecce restano nascoste -->
        <button id="prev" class="hidden" title="Giorno precedente">◀︎ Giorno precedente</button>
        <button id="next" class="hidden" title="Giorno successivo">Giorno successivo ▶︎</button>
        <button id="copy">Copia testo</button>
        <a id="openImg" class="btn hidden" href="#" target="_blank" rel="noopener">Apri immagine</a>
      </div>
    </div>
  </div>

  <script>
  // === CONFIG ===
  const MODE = 'shuffle';       // 'shuffle' = random senza ripetizioni (persistente) | 'daily' = 1 al giorno
  const TIMEZONE = 'Europe/Rome';
  const SEED = 'perle-v8';

  // === LOAD DATA ===
  async function loadItems(){
    const res = await fetch('items.json', { cache: 'no-cache' });
    if(!res.ok) throw new Error('Impossibile caricare items.json: '+res.status);
    const txt = await res.text();
    const data = JSON.parse(txt);
    if(!Array.isArray(data)) throw new Error('items.json non è un array');
    // filtro “anti-minchiate”: solo oggetti con text stringa e niente CSS incollato
    const clean = data.filter(it => it && typeof it.text === 'string' && !/^\s*html,\s*body\s*\{/.test(it.text));
    return { items: clean, hash: hashString(txt) };
  }

  // === UTIL ===
  function xmur3(str){ let h=1779033703^str.length; for(let i=0;i<str.length;i++){ h=Math.imul(h^str.charCodeAt(i),3432918353); h=h<<13|h>>>19; } return function(){ h=Math.imul(h^(h>>>16),2246822507); h=Math.imul(h^(h>>>13),3266489909); return (h^(h>>>16))>>>0; } }
  function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),1|t); t^=t+Math.imul(t^(t>>>7),61|t); return ((t^(t>>>14))>>>0)/4294967296; } }
  function seededShuffle(arr, seedStr){ const seed = xmur3(seedStr)(); const rand = mulberry32(seed); const a = arr.slice(); for (let i=a.length-1; i>0; i--){ const j = Math.floor(rand()*(i+1)); [a[i], a[j]]=[a[j], a[i]]; } return a; }
  function hashString(str){ const seedFn = xmur3(str); return seedFn(); }
  function nowInTZ(tz){ return new Date(new Date().toLocaleString('en-GB', { timeZone: tz })); }
  function startOfDayTZ(d, tz){ const p=new Intl.DateTimeFormat('en-CA',{ timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit'}).formatToParts(d); const y=+p.find(q=>q.type==='year').value; const m=+p.find(q=>q.type==='month').value; const day=+p.find(q=>q.type==='day').value; return new Date(Date.UTC(y, m-1, day)); }
  function daysSinceEpochTZ(d, tz){ const sod=startOfDayTZ(d, tz); return Math.floor(sod.getTime()/86400000); }

  // === STATE ===
  let ITEMS = [], ITEMS_HASH = 0, offsetDays = 0;

  // === SHUFFLE (persistente) ===
  const LS_KEY_PREFIX = 'perle_state_';
  function loadShuffleState(len, hash){
    const key = LS_KEY_PREFIX + hash;
    try{
      const raw = localStorage.getItem(key);
      if(raw){
        const st = JSON.parse(raw);
        if(Array.isArray(st.order) && st.order.length===len && Number.isInteger(st.pos)){
          let pos = st.pos;
          if (pos < 0) pos = 0;
          if (pos > len) pos = len;   // consenti pos === len per far scattare il rimescolo
          return { key, order: st.order, pos };
        }
      }
    }catch{}
    const order = seededShuffle(Array.from({length: len}, (_,i)=>i), String(hash));
    return { key, order, pos: 0 };
  }
  function saveShuffleState(state){ localStorage.setItem(state.key, JSON.stringify({order: state.order, pos: state.pos})); }
  function nextShuffleItem(items, state){
    if(items.length===0) return { item:{text:'— (nessuna frase) —'}, state };
    if(state.pos >= state.order.length){
      state.order = seededShuffle(Array.from({length: items.length}, (_,i)=>i), String(ITEMS_HASH ^ Date.now()));
      state.pos = 0;
    }
    const idx = state.order[state.pos];
    const item = items[idx];
    state.pos += 1;
    saveShuffleState(state);
    return { item, state };
  }

  // === RESPONSIVE IMAGE FIT ===
  function fitToScreen() {
    const card = document.querySelector('.card');
    const header = document.querySelector('h1').parentElement;
    const footer = document.querySelector('.footer');
    const imgbox = document.getElementById('imgbox');
    const fig = document.getElementById('figure');
    if (!imgbox || fig.classList.contains('hidden')) return;

    const vv = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    const cs = getComputedStyle(card);
    const padV = parseFloat(cs.paddingTop) + parseFloat(cs.paddingBottom);

    const Hh = header ? header.offsetHeight : 0;
    const Hf = footer ? footer.offsetHeight : 0;

    // margine respirazione
    const available = Math.max(140, vv - padV - Hh - Hf - 16);
    imgbox.style.maxHeight = available + 'px';

    const img = document.getElementById('img');
    if (img) {
      img.style.maxHeight = '100%';
      img.style.width = '100%';
      img.style.objectFit = 'contain';
    }
  }

  // === RENDER ===
  const elDate = document.getElementById('date');
  const elPhrase = document.getElementById('phrase');
  const elFig = document.getElementById('figure');
  const elImg = document.getElementById('img');
  const elCap = document.getElementById('caption');
  const aOpen = document.getElementById('openImg');
  const btnPrev = document.getElementById('prev');
  const btnNext = document.getElementById('next');

  function render(){
    let item;
    if(MODE==='shuffle'){
      const st = loadShuffleState(ITEMS.length, ITEMS_HASH);
      const res = nextShuffleItem(ITEMS, st);
      item = res.item;
      elDate.textContent = '';
      btnPrev.classList.add('hidden');
      btnNext.classList.add('hidden');
    } else {
      const now = nowInTZ(TIMEZONE);
      const view = new Date(now.getTime() + offsetDays*86400000);
      const perm = seededShuffle(ITEMS.map((_,i)=>i), SEED);
      const idx = daysSinceEpochTZ(view, TIMEZONE) % ITEMS.length;
      item = ITEMS[perm[idx]];
      const fmt = new Intl.DateTimeFormat('it-IT', { timeZone: TIMEZONE, weekday:'long', year:'numeric', month:'long', day:'numeric' });
      elDate.textContent = fmt.format(view);
      btnPrev.classList.remove('hidden');
      btnNext.classList.remove('hidden');
    }

    elPhrase.textContent = item.text || '';

    if(item.img){
      elImg.src = item.img; elImg.alt = item.alt || '';
      elCap.textContent = item.caption || '';
      elFig.classList.remove('hidden');
      aOpen.classList.remove('hidden'); aOpen.href = item.img;
    } else {
      elFig.classList.add('hidden');
      aOpen.classList.add('hidden');
      elImg.removeAttribute('src'); elImg.alt=''; elCap.textContent='';
    }

    // adatta l'immagine allo spazio reale del device
    requestAnimationFrame(fitToScreen);
    if (elImg) elImg.onload = fitToScreen;
  }

  // === INIT ===
  async function init(){
    const elError = document.getElementById('error');
    try{
      const {items, hash} = await loadItems();
      ITEMS = items; ITEMS_HASH = hash;
      if(!ITEMS.length) throw new Error('Nessun elemento in items.json');
      render();
      addEventListener('resize', fitToScreen);
      addEventListener('orientationchange', fitToScreen);
    }catch(err){
      elError.classList.remove('hidden');
      elError.textContent = err.message + '\nAssicurati che esista items.json valido (array di oggetti con almeno {"text":"..."})';
    }
  }

  // === EVENTS ===
  btnPrev.addEventListener('click', ()=>{ if(MODE==='daily'){ offsetDays--; render(); } });
  btnNext.addEventListener('click', ()=>{ if(MODE==='daily'){ offsetDays++; render(); } });
  document.getElementById('copy').addEventListener('click', async (ev)=>{
    try { await navigator.clipboard.writeText(elPhrase.textContent); const b=ev.currentTarget; const t=b.textContent; b.textContent='Copiato!'; setTimeout(()=>b.textContent=t,1200); }
    catch(e){ alert('Impossibile copiare: '+e); }
  });

  init();
  </script>
</body>
</html>
